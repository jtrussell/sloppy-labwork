{% extends 'page.html' %}
{% load static %}
{% load posts_extras %}

{% block head_title %}{{ version.name }} - {{ lineup.name }} - Sloppy Labwork{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'lineups/main.css' %}">
{% endblock %}

{% block content %}
<nav class="breadcrumb">
  <a href="{% url 'lineups-list' %}">Lineups</a> &raquo;
  <a href="{% url 'lineups-detail' lineup.code %}">{{ lineup.name }}</a> &raquo;
  {{ version.name }}
</nav>

<div class="version-header">
  <div class="version-header__info">
    <h1>{{ version.name }}</h1>
    <span class="lineup-visibility lineup-visibility--{{ version.get_effective_visibility }}">
      {{ version.get_effective_visibility|capfirst }}{% if not version.visibility_override %} <span class="visibility-inherited">(inherited)</span>{% endif %}
    </span>
  </div>
</div>

{% if version.description %}
<div class="version-description">
  {{ version.description|markdown|safe }}
</div>
{% endif %}

<div class="version-meta">
  <span>Created: {{ version.created_on|date:"M j, Y" }}</span>
  <span>Updated: {{ version.updated_on|date:"M j, Y" }}</span>
</div>

{% if is_owner %}
<div class="entity-actions">
  <a href="{% url 'lineups-version-edit' lineup.code version.code %}" class="button">Edit</a>
  <form method="post" action="{% url 'lineups-version-delete' lineup.code version.code %}" class="inline-form">
    {% csrf_token %}
    <button type="submit" class="button" hx-confirm="Are you sure you want to delete this version?">Delete</button>
  </form>
</div>
{% endif %}

<section class="version-section">
  <div class="section-header">
    <h2>Decks</h2>
  </div>

  {% if is_owner %}
  <form method="post" action="{% url 'lineups-version-deck-add' lineup.code version.code %}" class="deck-add-form">
    {% csrf_token %}
    <div class="deck-add-row" style="padding-bottom: 0.5rem">
      {{ deck_form.deck_url }}
      <button type="submit" class="button button-primary">Add Deck</button>
    </div>
    <p class="helptext">Paste a Master Vault URL or DoK URL</p>
  </form>
  {% endif %}

  <div id="decks-list">
    {% if decks %}
    {% for vd in decks %}
    <div class="deck-card" id="deck-{{ vd.id }}">
      <h3 class="deck-card__title"><a href="{{ vd.deck.get_dok_url }}" target="_blank" rel="noopener">{{ vd.deck.name }}</a></h3>
      <div class="deck-card__footer">
        <div class="deck-card__icons">
          {% if vd.deck.set.src %}<img src="{{ vd.deck.set.src }}" alt="{{ vd.deck.set.name }}" class="deck-icon deck-icon--set">{% endif %}
          <span>&nbsp;</span>
          {% if vd.deck.house_1.src %}<img src="{{ vd.deck.house_1.src }}" alt="{{ vd.deck.house_1.name }}" class="deck-icon">{% endif %}
          {% if vd.deck.house_2.src %}<img src="{{ vd.deck.house_2.src }}" alt="{{ vd.deck.house_2.name }}" class="deck-icon">{% endif %}
          {% if vd.deck.house_3.src %}<img src="{{ vd.deck.house_3.src }}" alt="{{ vd.deck.house_3.name }}" class="deck-icon">{% endif %}
        </div>
        {% if is_owner %}
        <div class="deck-card__actions">
          <form method="post" action="{% url 'lineups-version-deck-remove' lineup.code version.code vd.id %}" class="inline-form">
            {% csrf_token %}
            <button type="submit" class="button button-small" hx-confirm="Remove this deck?" hx-target="#deck-{{ vd.id }}" hx-swap="outerHTML">Remove</button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="empty-message">No decks in this version yet.</p>
    {% endif %}
  </div>

  {% if decks %}
  <div class="export-actions">
    {% if version.get_effective_visibility != 'private' %}
    <a href="{{ request.path }}?f=json" class="button button-small">‚öôÔ∏è JSON</a>
    <a href="{{ request.path }}?f=xml" class="button button-small">‚öôÔ∏è XML</a>
    {% endif %}
    <span class="spacer"></span>
    <button type="button" class="button button-small" id="copy-deck-links">üìã Copy Deck Links</button>
  </div>
  <script>
    document.getElementById('copy-deck-links').addEventListener('click', function() {
      const deckLinks = [{% for vd in decks %}'{{ vd.deck.get_dok_url }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
      navigator.clipboard.writeText(deckLinks.join('\n')).then(function() {
        alert('Deck links copied to clipboard!');
      });
    });
  </script>
  {% endif %}
</section>

<section class="version-section">
  <div class="section-header">
    <h2>Notes</h2>
  </div>

  {% if is_owner %}
  <form method="post" action="{% url 'lineups-version-note-add' lineup.code version.code %}" class="note-form">
    {% csrf_token %}
    {{ note_form.text }}
    <button type="submit" class="button button-primary">Add Note</button>
  </form>
  {% endif %}

  <div id="notes-list">
    {% for note in notes %}
    {% include 'lineups/partials/version-note-item.html' %}
    {% empty %}
    <p class="empty-message">No notes yet.</p>
    {% endfor %}
  </div>

  {% if notes.paginator.num_pages > 1 %}
  <div class="pagination">
    {% if notes.has_previous %}
    <a href="?np={{ notes.previous_page_number }}" class="button">&laquo; Prev</a>
    {% endif %}
    <span class="pagination-info">Page {{ notes.number }} of {{ notes.paginator.num_pages }}</span>
    {% if notes.has_next %}
    <a href="?np={{ notes.next_page_number }}" class="button">Next &raquo;</a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}
