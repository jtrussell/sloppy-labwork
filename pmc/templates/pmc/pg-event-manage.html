{% extends "pmc/_base.html" %}
{% load partials %}

{% partialdef result-row-lg %}
  <tr hx-target="this">
    <td class="col-sm">{{ result.finishing_position|default_if_none:"-" }}</td>
    <td>
      <div class="name-with-avatar">
      <img class="avatar" src="{{ result.user.pmc_profile.get_avatar.src}}" alt="">
        {{ result.user }}
      </div>
    </td>
    <td class="stat">{{ result.num_wins|default_if_none:"-" }}</td>
    <td class="stat">{{ result.num_losses|default_if_none:"-" }}</td>
    <td class="stat">{{ result.ranking_points.first|default_if_none:"-" }}</td>
    <td class="staff-only col-sm">
      <a
        class="btn"
        hx-delete="{% url 'pmc-pg-manage-result' playgroup.slug result.pk %}"
        hx-swap="outerHTML"
        hx-target="#results-table"
      >X</a>
    </td>
  </tr>
{% endpartialdef %}

{% partialdef result-row-sm %}
  <tr hx-target="this">
    <td class="col-sm text-larger">{{ result.finishing_position|default_if_none:"-" }}</td>
    <td style="width: 100%;">
      <div class="name-with-avatar text-larger">
      <img class="avatar" src="{{ result.user.pmc_profile.get_avatar.src}}" alt="">
        {{ result.user }}
      </div>
      <div class="flex flex-row flex-gap-1 text-muted text-smaller">
        <span>Wins: {{ result.num_wins|default_if_none:"-" }}</span>
        <span>Losses: {{ result.num_losses|default_if_none:"-" }}</span>
        <span>RP: {{ result.ranking_points.first|default_if_none:"-" }}</span>
      </div>
    </td>
    <td class="staff-only col-sm">
      <a
        class="btn"
        hx-delete="{% url 'pmc-pg-manage-result' playgroup.slug result.pk %}"
        hx-swap="outerHTML"
        hx-target="#results-table"
      >X</a>
    </td>
  </tr>
{% endpartialdef %}

{% partialdef results-table-lg %}
    <table id="results-table" class="lg-only">
      <tr>
        <th title="Finishing Position">#</th>
        <th class="text-left">Player</th>
        <th title="Wins">W</th>
        <th title="Losses">L</th>
        <th title="Ranking Points">RP</th>
        <th class="staff-only"></th>&nbsp;</th>
      </tr>

      {% for result in object.results.all %}
        {% partial result-row-lg %}
      {% endfor %}

      <tr class="staff-only" id="add-result-row">
        <td colspan="6">
          <div class="flex flex-row flex-col-sm flex-gap-1">
            <label class="sm-only">Finishing Position</label>
            <input id="form-entry-point" type="number" class="stat" placeholder="#" name="finishing_position" />

            <label class="sm-only" for="username">Username</label>
            <input required type="text" class="flex-1" name="username" list="usernames-list" placeholder="Username"/>
            <datalist id="usernames-list">
              {% for member in playgroup.members.all %}
                <option value="{{ member.user.username }}">
              {% endfor %}
            </datalist>

            <label class="sm-only" for="num_wins">Number of Wins</label>
            <input type="number" class="stat" placeholder="W" name="num_wins">

            <label class="sm-only" for="num_losses">Number of Losses</label>
            <input type="number" class="stat" placeholder="L" name="num_losses">
            <button type="submit" class="btn btn-solid">Add</button>
          </div>
        </td>
      </tr>
    </table>
{% endpartialdef %}

{% partialdef results-table-sm %}
  <table class="sm-only">
    <tr>
      <th title="Finishing Position">#</th>
      <th class="text-left">Player</th>
      <th>&nbsp;</th>
    </tr>

    {% for result in object.results.all %}
      {% partial result-row-sm %}
    {% endfor %}

    <tr class="staff-only" id="add-result-row">
      <td colspan="3">
        <div class="flex flex-row flex-col-sm flex-gap-1">
          <label class="sm-only">Finishing Position</label>
          <input id="form-entry-point" type="number" class="stat" placeholder="#" name="finishing_position" />

          <label class="sm-only" for="username">Username</label>
          <input required type="text" class="flex-1" name="username" list="usernames-list" placeholder="Username"/>
          <datalist id="usernames-list">
            {% for member in playgroup.members.all %}
              <option value="{{ member.user.username }}">
            {% endfor %}
          </datalist>

          <label class="sm-only" for="num_wins">Number of Wins</label>
          <input type="number" class="stat" placeholder="W" name="num_wins">

          <label class="sm-only" for="num_losses">Number of Losses</label>
          <input type="number" class="stat" placeholder="L" name="num_losses">
          <button type="submit" class="btn btn-solid">Add</button>
        </div>
      </td>
    </tr>
  </table>
{% endpartialdef %}


{% partialdef results-table %}
  {% partial results-table-sm %}
  {% partial results-table-lg %}
{% endpartialdef %}

{% block content %}
  <h1>{{ object }}</h1>
  <div class="subheading">
    <ul class="inline-list">
      <li>{{ object.start_date }}</li>
      <li>{{ object.get_player_count }} Players</li>
      {% if object.format is not None %}
      <li>{{ object.format }}</li>
      {% endif %}
    </ul>
  </div>
  
	<form method="POST" class="card staff-only">
		<h2>Staff Area</h2>
      {% csrf_token %}
      {{ form.as_p }}
      <div class="card-actions">
        <a href="{% url 'pmc-pg-event-detail' playgroup.slug object.pk %}" class="btn">
          &larr; Back
        </a>
        <span class="flex-1"></span>
        <button class="btn btn-solid" type="submit">Update</button>
      </div>
  </form>
    
  <div class="card staff-only">
    <h2>Danger Zone</h2>
    <p>No take backsies.</p>
    
    <div class="card-actions">
      <!-- form for event points -->
      <form action="{% url 'pmc-delete-event' playgroup.slug object.pk %}" method="POST">
        {% csrf_token %}
        <button class="btn" type="submit">
          Delete Event
        </button>
      </form>
    </div>
		</a>
	</div>

  <div class="card">
    <h2>Results</h2>
    <form
      autocomplete="off"
      hx-post="{% url 'pmc-pg-add-event-result' playgroup.slug object.pk %}"
      hx-target="#results-table"
      hx-swap="outerHTML"
      hx-on::after-request="if(event.detail.successful) { this.reset(); htmx.find('#form-entry-point').focus() }"
    >
      {% partial results-table %}
    </form>
  </div>
{% endblock %}