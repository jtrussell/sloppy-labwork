<div id="{{ match_id_prefix|default:'' }}match-{{ match.id }}" class="match-card {% if match.has_result %}match-card--completed{% endif %}">
    {% if show_match_number %}
        <div class="match-number">{{ match_number|default:forloop.counter }}</div>
    {% else %}
        {% comment %}For pending matches, calculate match position{% endcomment %}
        {% with match_round_matches=match.round.matches.all %}
            {% for round_match in match_round_matches %}
                {% if round_match == match %}
                    <div class="match-number">{{ forloop.counter }}</div>
                {% endif %}
            {% endfor %}
        {% endwith %}
    {% endif %}

    <div class="match-players">
        {% if match.is_bye %}
            <div class="match-player match-player--winner">
                {{ match.player_one.player.get_display_name }}
                {% if match.player_one.player.is_guest %}
                    <span class="player-guest-badge"></span>
                {% endif %}
            </div>
            <div class="match-player match-player--bye">
                BYE
            </div>
        {% else %}
            {% if match.has_result %}
                {% if match.result.winner == match.player_one %}
                    <div class="match-player match-player--winner">
                        {{ match.player_one.player.get_display_name }}
                        {% if match.player_one.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                        {% if match.round.stage.report_full_scores != 0 and match.result.player_one_score is not None and match.result.player_two_score is not None %}
                            <span class="match-score match-score--winner">{{ match.result.player_one_score }}</span>
                        {% endif %}
                    </div>
                    <div class="match-player match-player--loser">
                        {{ match.player_two.player.get_display_name }}
                        {% if match.player_two.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                        {% if match.round.stage.report_full_scores != 0 and match.result.player_one_score is not None and match.result.player_two_score is not None %}
                            <span class="match-score match-score--loser">{{ match.result.player_two_score }}</span>
                        {% endif %}
                    </div>
                {% elif match.result.winner == match.player_two %}
                    <div class="match-player match-player--loser">
                        {{ match.player_one.player.get_display_name }}
                        {% if match.player_one.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                        {% if match.round.stage.report_full_scores != 0 and match.result.player_one_score is not None and match.result.player_two_score is not None %}
                            <span class="match-score match-score--loser">{{ match.result.player_one_score }}</span>
                        {% endif %}
                    </div>
                    <div class="match-player match-player--winner">
                        {{ match.player_two.player.get_display_name }}
                        {% if match.player_two.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                        {% if match.round.stage.report_full_scores != 0 and match.result.player_one_score is not None and match.result.player_two_score is not None %}
                            <span class="match-score match-score--winner">{{ match.result.player_two_score }}</span>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Tie -->
                    <div class="match-player">
                        {{ match.player_one.player.get_display_name }}
                        {% if match.player_one.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                        {% if match.round.stage.report_full_scores != 0 and match.result.player_one_score is not None and match.result.player_two_score is not None %}
                            <span class="match-score match-score--tie">({{ match.result.player_one_score }})</span>
                        {% endif %}
                    </div>
                    <div class="match-player">
                        {{ match.player_two.player.get_display_name }}
                        {% if match.player_two.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                        {% if match.round.stage.report_full_scores != 0 and match.result.player_one_score is not None and match.result.player_two_score is not None %}
                            <span class="match-score match-score--tie">({{ match.result.player_two_score }})</span>
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <!-- Pending match -->
                <div class="match-player match-player--pending">
                    {{ match.player_one.player.get_display_name }}
                    {% if match.player_one.player.is_guest %}
                        <span class="player-guest-badge"></span>
                    {% endif %}
                </div>
                <div class="match-player match-player--pending">
                    {% if match.player_two %}
                        {{ match.player_two.player.get_display_name }}
                        {% if match.player_two.player.is_guest %}
                            <span class="player-guest-badge"></span>
                        {% endif %}
                    {% else %}
                        <em>TBD</em>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
    </div>

    <div class="match-actions">
        {% comment %} Check if user can edit this match {% endcomment %}
        {% if match.is_bye %}
            {% comment %} For bye matches, only admins can delete them {% endcomment %}
            {% if is_admin %}
                <button class="match-edit-btn"
                    data-match-id="{{ match.id }}"
                    data-update-action="{% url 'tourney-report-result' tournament.code match.id %}"
                    data-delete-action="{% url 'tourney-delete-match' tournament.code match.id %}"
                    data-reset-action="{% url 'tourney-reset-match' tournament.code match.id %}"
                    data-match-player-one="{{ match.player_one.player.get_display_name }}"
                    data-match-player-one-id="{{ match.player_one.id }}"
                    data-match-player-two=""
                    data-match-player-two-id=""
                    data-match-has-result="true"
                    data-match-winner-id="{{ match.player_one.id }}"
                    data-match-is-bye="true"
                    data-is-admin="{{ is_admin|yesno:'true,false' }}"
                    data-stage-allow-ties="{{ match.round.stage.are_ties_allowed|yesno:'true,false' }}"
                    data-stage-score-reporting="{{ match.round.stage.report_full_scores }}"
                    onclick="openMatchModal(this)">
                </button>
            {% endif %}
        {% else %}
            {% comment %} For regular matches, check normal edit permissions {% endcomment %}
            {% if is_admin or match.player_one.player.user == user or match.player_two.player.user == user %}
                {% if is_admin or not tournament.is_closed %}
                    <button class="match-edit-btn"
                        data-match-id="{{ match.id }}"
                        data-update-action="{% url 'tourney-report-result' tournament.code match.id %}"
                        data-delete-action="{% url 'tourney-delete-match' tournament.code match.id %}"
                        data-reset-action="{% url 'tourney-reset-match' tournament.code match.id %}"
                        data-match-player-one="{{ match.player_one.player.get_display_name }}"
                        data-match-player-one-id="{{ match.player_one.id }}"
                        {% if match.player_two %}
                        data-match-player-two="{{ match.player_two.player.get_display_name }}"
                        data-match-player-two-id="{{ match.player_two.id }}"
                        {% endif %}
                        data-match-has-result="{% if match.has_result %}true{% else %}false{% endif %}"
                        {% if match.has_result %}
                        data-match-winner-id="{% if match.result.winner %}{{ match.result.winner.id }}{% endif %}"
                        data-match-player-one-score="{% if match.result.player_one_score is not None %}{{ match.result.player_one_score }}{% endif %}"
                        data-match-player-two-score="{% if match.result.player_two_score is not None %}{{ match.result.player_two_score }}{% endif %}"
                        {% endif %}
                        data-is-admin="{{ is_admin|yesno:'true,false' }}"
                        data-stage-allow-ties="{{ match.round.stage.are_ties_allowed|yesno:'true,false' }}"
                        data-stage-score-reporting="{{ match.round.stage.report_full_scores }}"
                        onclick="openMatchModal(this)">
                    </button>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>
</div>