{% extends "tourney/_base.html" %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'tourney/drag-drop.css' %}">
    <link rel="stylesheet" href="{% static 'tourney/ranking-criteria.css' %}">
    {{ block.super }}
{% endblock %}

{% block content %}
{% if tournament %}
    <h1>{{ tournament.name }}</h1>
    <div class="subheading">
        <a href="{% url 'tourney-detail-home' tournament.code %}">&larr; Back</a> â€¢ Edit Tournament
    </div>
{% else %}
    <h1>Create Tournament</h1>
{% endif %}

<form method="post" class="form-wide">
    {% csrf_token %}

    <section>
        <h2>Tournament Details</h2>

        <div class="row">
            <div class="twelve columns">
                <label for="{{ form.name.id_for_label }}">Tournament Name</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="form-error">{{ form.name.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="twelve columns">
                <label for="{{ form.description.id_for_label }}">Description</label>
                {{ form.description }}
                <span class="helptext">Markdown formatted. Start with h3's (###) for section headers.</span>
                {% if form.description.errors %}
                    <div class="form-error">{{ form.description.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="twelve columns">
                <label>
                    {{ form.is_accepting_registrations }}
                    {% if tournament %}Accept registrations{% else %}Accept registrations immediately{% endif %}
                </label>
                {% if form.is_accepting_registrations.errors %}
                    <div class="form-error">{{ form.is_accepting_registrations.errors }}</div>
                {% endif %}
            </div>
        </div>

        {% if tournament %}
        <div class="row">
            <div class="twelve columns">
                <label>
                    {{ form.is_closed }}
                    Close tournament
                </label>
                {% if form.is_closed.help_text %}
                    <span class="helptext">{{ form.is_closed.help_text }}</span>
                {% endif %}
                {% if form.is_closed.errors %}
                    <div class="form-error">{{ form.is_closed.errors }}</div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="row">
            <div class="twelve columns">
                <label>
                    {{ form.is_public }}
                    Public tournament
                </label>
                <span class="helptext">Allow anyone to view standings and matches without logging in</span>
                {% if form.is_public.errors %}
                    <div class="form-error">{{ form.is_public.errors }}</div>
                {% endif %}
            </div>
        </div>
    </section>

    <section>
        <h2>Main Stage</h2>

        <div class="row">
            <div class="twelve columns">
                <label for="{{ form.main_pairing_strategy.id_for_label }}">{{ form.main_pairing_strategy.label }}</label>
                {{ form.main_pairing_strategy }}
                {% if form.main_pairing_strategy.errors %}
                    <div class="form-error">{{ form.main_pairing_strategy.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="six columns">
                <label for="{{ form.main_score_reporting.id_for_label }}">{{ form.main_score_reporting.label }}</label>
                {{ form.main_score_reporting }}
                {% if form.main_score_reporting.errors %}
                    <div class="form-error">{{ form.main_score_reporting.errors }}</div>
                {% endif %}
            </div>
            <div class="six columns">
                <label for="{{ form.main_allow_ties.id_for_label }}">{{ form.main_allow_ties.label }}</label>
                {{ form.main_allow_ties }}
                {% if form.main_allow_ties.errors %}
                    <div class="form-error">{{ form.main_allow_ties.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="six columns">
                <label for="{{ form.main_max_players.id_for_label }}">{{ form.main_max_players.label }}</label>
                {{ form.main_max_players }}
                {% if form.main_max_players.help_text %}
                    <span class="helptext">{{ form.main_max_players.help_text }}</span>
                {% endif %}
                {% if form.main_max_players.errors %}
                    <div class="form-error">{{ form.main_max_players.errors }}</div>
                {% endif %}
            </div>
            <div class="six columns">
                <label for="{{ form.main_round_length.id_for_label }}">{{ form.main_round_length.label }}</label>
                {{ form.main_round_length }}
                {% if form.main_round_length.help_text %}
                    <span class="helptext">{{ form.main_round_length.help_text }}</span>
                {% endif %}
                {% if form.main_round_length.errors %}
                    <div class="form-error">{{ form.main_round_length.errors }}</div>
                {% endif %}
            </div>
        </div>
    </section>

    <section>
        <h2>Main Stage Ranking Criteria</h2>
        <p>Drag to reorder the criteria by importance. Toggle criteria on/off with the switches.</p>

        <!-- Hidden fields for each criterion -->
        {% for criterion in available_criteria %}
            <input type="hidden" id="criterion_{{ criterion.get_key }}_enabled" name="criterion_{{ criterion.get_key }}_enabled" value="">
            <input type="hidden" id="criterion_{{ criterion.get_key }}_order" name="criterion_{{ criterion.get_key }}_order" value="">
        {% endfor %}

        <div id="ranking-criteria-list" class="drag-drop-container ranking-criteria-container">
            <!-- Criteria items will be populated by JavaScript -->
        </div>
    </section>

    <section>
        <h2>Playoff Stage</h2>

        <div class="row">
            <div class="twelve columns">
                <label>
                    {{ form.enable_playoffs }}
                    {{ form.enable_playoffs.label }}
                </label>
                {% if form.enable_playoffs.errors %}
                    <div class="form-error">{{ form.enable_playoffs.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div id="playoff-options"{% if not tournament %} style="display: none;"{% endif %}>
            <div class="row">
                <div class="six columns">
                    <label for="{{ form.playoff_score_reporting.id_for_label }}">{{ form.playoff_score_reporting.label }}</label>
                    {{ form.playoff_score_reporting }}
                    {% if form.playoff_score_reporting.help_text %}
                        <span class="helptext">{{ form.playoff_score_reporting.help_text }}</span>
                    {% endif %}
                    {% if form.playoff_score_reporting.errors %}
                        <div class="form-error">{{ form.playoff_score_reporting.errors }}</div>
                    {% endif %}
                </div>
                <div class="six columns">
                    <label for="{{ form.playoff_max_players.id_for_label }}">{{ form.playoff_max_players.label }}</label>
                    {{ form.playoff_max_players }}
                    {% if form.playoff_max_players.help_text %}
                        <span class="helptext">{{ form.playoff_max_players.help_text }}</span>
                    {% endif %}
                    {% if form.playoff_max_players.errors %}
                        <div class="form-error">{{ form.playoff_max_players.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="six columns">
                    <label for="{{ form.playoff_round_length.id_for_label }}">{{ form.playoff_round_length.label }}</label>
                    {{ form.playoff_round_length }}
                    {% if form.playoff_round_length.help_text %}
                        <span class="helptext">{{ form.playoff_round_length.help_text }}</span>
                    {% endif %}
                    {% if form.playoff_round_length.errors %}
                        <div class="form-error">{{ form.playoff_round_length.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <section>
        
        {% if source_tournament %}
            <button type="submit" class="button button-primary">Clone Tournament</button>
            <a href="{% url 'tourney-my-tournaments' %}" class="button">Cancel</a>
        {% elif tournament %}
            <button type="submit" class="button button-primary">Update Tournament</button>
            <a href="{% url 'tourney-detail-home' tournament.code %}" class="button">Back</a>
        {% else %}
            <button type="submit" class="button button-primary">Create Tournament</button>
            <a href="{% url 'tourney-my-tournaments' %}" class="button">Cancel</a>
        {% endif %}
    </section>
</form>

{% endblock %}

{% block extra_body %}
{{ block.super }}
<script src="{% static 'tourney/ranking-criteria.js' %}"></script>
<script src="{% static 'tourney/tournament-form.js' %}"></script>
<script>
{% if tournament %}
window.currentCriteriaData = {{ current_criteria_json|safe }};
{% endif %}

document.addEventListener('DOMContentLoaded', function() {
    setupPlayoffToggle('#{{ form.enable_playoffs.id_for_label }}', '#playoff-options');
    new RankingCriteriaManager('#ranking-criteria-list', null);
});
</script>
{% endblock %}