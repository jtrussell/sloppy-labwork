{% extends "tourney/tournament-detail-base.html" %}

{% block tab_content %}
<div id="tournament-content">
    {% if not user.is_authenticated and not tournament.is_public %}
        <section>
            <p class="text-muted" style="text-align: center; font-style: italic;">
                Please log in to view match details and participate in this tournament.
            </p>
        </section>
    {% else %}
        <!-- All Tournament Matches -->
        {% if grouped_matches %}
            {% for stage_group in grouped_matches %}
                <section class="stack gap-2">
                    <div>
                        <h2>{{ stage_group.stage.name }}</h2>
                        {% for round_group in stage_group.rounds %}
                            <h3>Round {{ round_group.round.order }}</h3>
                            <div class="subheading">
                                {{ stage_group.stage.name }}
                                {% if is_admin %}
                                    <span class="subheading-separator">â€¢</span>
                                    <form method="post"
                                          style="display:inline;"
                                          hx-target="#tournament-content"
                                          hx-swap="outerHTML"
                                          hx-post="{% url 'tourney:tourney-delete-round' tournament.code round_group.round.id %}"
                                          hx-confirm="Are you sure you want to delete this round? All rounds that come after will also be deleted.">
                                        {% csrf_token %}
                                        <button type="submit" class="button-link">
                                            Delete Round
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                            {% if round_group.matches %}
                                <div class="match-grid">
                                    {% for match in round_group.matches %}
                                        {% include 'tourney/partials/match-card.html' with match=match is_admin=is_admin show_match_number=True match_number=forloop.counter %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% endfor %}

            {% comment %} Show unmatched players for the latest round if any and if strategy allows {% endcomment %}
            {% if unmatched_players and show_unmatched_players %}
                <section>
                    <div class="unmatched-players-section">
                        <h3>Players Not Matched (Latest Round)</h3>
                        <div class="unmatched-players-grid">
                            {% for stage_player in unmatched_players %}
                                <div class="unmatched-player-card">
                                    <span class="player-name">{{ stage_player.player.get_display_name }}</span>
                                    {% if stage_player.player.is_guest %}
                                        <span class="player-guest-badge"></span>
                                    {% endif %}
                                    <span class="player-seed">Seed {{ stage_player.seed }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>
            {% endif %}
        {% else %}
            <section>
                <p class="text-muted" style="text-align: center;">No matches have been created yet.</p>
            </section>
        {% endif %}
    {% endif %}

    {% include 'tourney/partials/tournament-control.html' %}

    {% if can_report_result %}
        <section>
            <h2>Quick Actions</h2>
            <div class="hstack gap-1">
                <button
                    type="button"
                    class="button button-primary sm-w100"
                {% if not tournament.is_closed %}
                    onclick="openPlayerMatchReportModal()"
                {% else %}
                    disabled
                    title="Tournament is closed - match reporting is disabled"
                {% endif %}
                >Report Match Result</button>
            </div>
        </section>
    {% endif %}
</div>
{% endblock %}