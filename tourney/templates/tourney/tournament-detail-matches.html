{% extends "tourney/tournament-detail-base.html" %}

{% block tab_content %}
<div id="tournament-content">
    {% if not user.is_authenticated %}
        <section>
            <p class="text-muted" style="text-align: center; font-style: italic;">
                Please log in to view match details and participate in this tournament.
            </p>
        </section>
    {% else %}
        <!-- All Tournament Matches -->
        {% if grouped_matches %}
            {% for stage_group in grouped_matches %}
                <section class="stack gap-2">
                    <div>
                        <h2>{{ stage_group.stage.name }}</h2>
                        {% for round_group in stage_group.rounds %}
                            <h3>Round {{ round_group.round.order }}</h3>
                            <div class="subheading">{{ stage_group.stage.name }}</div>
                            {% if round_group.matches %}
                                <div class="match-grid">
                                    {% for match in round_group.matches %}
                                        {% include 'tourney/partials/match-card.html' with match=match is_admin=is_admin show_match_number=True match_number=forloop.counter %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </section>
            {% endfor %}

            {% comment %} Show unmatched players for the latest round if any and if strategy allows {% endcomment %}
            {% if unmatched_players and show_unmatched_players %}
                <section>
                    <div class="unmatched-players-section">
                        <h3>Players Not Matched (Latest Round)</h3>
                        <div class="unmatched-players-grid">
                            {% for stage_player in unmatched_players %}
                                <div class="unmatched-player-card">
                                    <span class="player-name">{{ stage_player.player.get_display_name }}</span>
                                    {% if stage_player.player.is_guest %}
                                        <span class="player-guest-badge"></span>
                                    {% endif %}
                                    <span class="player-seed">Seed {{ stage_player.seed }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>
            {% endif %}
        {% else %}
            <section>
                <p class="text-muted" style="text-align: center;">No matches have been created yet.</p>
            </section>
        {% endif %}
    {% endif %}


{% if user.is_authenticated %}
<section>
    {% if is_admin %}
        <h2>Tournament Control</h2>
        <div class="stack gap-2">
            {% comment %} Start Current Stage - for tournaments that need initial seeding {% endcomment %}
            {% if current_stage %}
            <div>
                <div class="text-small text-muted">Initialize {{ current_stage.name }} with player seeding if needed</div>
                <form method="post"
                      action="{% url 'tourney-prepare-current-stage-seeding' tournament.id %}"
                      style="display:inline;">
                    {% csrf_token %}
                    <button type="submit"
                            class="button sm-w100"
                            {% if not can_start_current_stage %}disabled{% endif %}>
                        Start {{ current_stage.name }}
                    </button>
                </form>
            </div>
            {% endif %}

            {% comment %} Create New Round - continue current stage with another round {% endcomment %}
            <div>
                <div class="text-small text-muted">Continue current stage with another round</div>
                <form method="post"
                      action="{% url 'tourney-create-round' tournament.id %}"
                      style="display:inline;"
                      hx-post="{% url 'tourney-create-round' tournament.id %}"
                      hx-target="#tournament-content"
                      hx-swap="outerHTML">
                    {% csrf_token %}
                    <button type="submit"
                            class="button sm-w100"
                            {% if not can_create_round %}disabled{% endif %}>
                        Create New Round
                    </button>
                </form>
            </div>

            {% comment %} Start Next Stage - advance to playoffs or next tournament stage {% endcomment %}
            {% if next_stage %}
            <div>
                <div class="text-small text-muted">Advance tournament to {{ next_stage.name }}</div>
                <form method="post"
                      action="{% url 'tourney-prepare-stage-seeding' tournament.id %}"
                      style="display:inline;">
                    {% csrf_token %}
                    <button type="submit"
                            class="button sm-w100"
                            {% if not can_start_next_stage %}disabled{% endif %}>
                        Start {{ next_stage.name }}
                    </button>
                </form>
            </div>
            {% endif %}

            {% comment %} Delete Latest Round - remove the most recent round and its matches {% endcomment %}
            <div>
                <div class="text-small text-muted">Remove the most recent round and all its matches</div>
                <form method="post"
                      style="display:inline;"
                      hx-target="#tournament-content"
                      hx-swap="outerHTML"
                      hx-post="{% url 'tourney-delete-latest-round' tournament.id %}"
                      hx-confirm="Are you sure you want to delete the latest round? This action cannot be undone and will remove all matches in the round.">
                    {% csrf_token %}
                    <button type="submit"
                            class="button sm-w100"
                            {% if not can_delete_latest_round %}disabled{% endif %}>
                        Delete Latest Round
                    </button>
                </form>
            </div>

            {% comment %} Add Match - create a match between two players or a bye match {% endcomment %}
            <div>
                <div class="text-small text-muted">Create a match between unmatched players or award a bye</div>
                <button type="button"
                        class="button sm-w100"
                        {% if unmatched_players.count < 1 %}disabled{% endif %}
                        onclick="openAddMatchModal()">
                    Add Match
                </button>
            </div>
        </div>
    {% endif %}
</section>
{% endif %}

{% if user.is_authenticated and can_add_match %}
<section>
    <h2>Quick Actions</h2>
    <div class="hstack gap-1">
        {% comment %} Report Match Result button - show for self-scheduled tournaments {% endcomment %}
        {% if not tournament.is_closed %}
        <button
            type="button"
            class="button button-primary sm-w100"
            onclick="openPlayerMatchReportModal()"
        >Report Match Result</button>
        {% else %}
        <button
            type="button"
            class="button button-muted sm-w100"
            disabled
            title="Tournament is closed - match reporting is disabled"
        >Report Match Result</button>
        {% endif %}
    </div>
</section>
{% endif %}
</div>
{% endblock %}