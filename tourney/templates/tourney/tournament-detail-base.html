{% extends "tourney/_base.html" %}
{% load partials %}
{% load posts_extras %}

{% block content %}
    <h1>{{ tournament.name }}</h1>

    {% if tournament.description %}
        <section>{{ tournament.description | markdown | safe }}</section>
    {% endif %}

    {% include "tourney/partials/tournament-detail-registration-status.html" %}

    <!-- Pending Matches for Current User -->
    {% if user.is_authenticated and is_active_player and pending_matches %}
    <section style="margin-bottom: 2rem;">
        <h2>Your Pending Matches</h2>
        {% for match in pending_matches %}
            <div style="margin-bottom: 1rem;">
                {% include 'tourney/partials/match-card.html' with match=match is_admin=is_admin show_match_number=False %}

                <div style="text-align: center; color: var(--color-text-muted); font-size: 1.2rem; margin-top: 0.5rem;">
                    {{ match.round.stage.name }} - Round {{ match.round.order }}
                </div>
            </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- Tab Navigation -->
     <section>
        <ul
            class="nav short"
            style="justify-content: center;"
        >
            <li class="nav__item">
                <a href="{% url 'tourney-detail-home' tournament.id %}" 
                class="nav__link {% if current_tab == 'home' %}nav__link--active{% endif %}">
                    Info
                </a>
            </li>
            <li class="nav__item">
                <a href="{% url 'tourney-detail-matches' tournament.id %}" 
                class="nav__link {% if current_tab == 'matches' %}nav__link--active{% endif %}">
                    Matches
                </a>
            </li>
            <li class="nav__item">
                <a href="{% url 'tourney-detail-standings' tournament.id %}" 
                class="nav__link {% if current_tab == 'standings' %}nav__link--active{% endif %}">
                    Standings
                </a>
            </li>
        </ul>
     </section>

     <section>
        {% block tab_content %}
        {% endblock %}
     </section>

    <!-- Match Result Modal -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Report Match Result</h3>
                <button class="modal-close" onclick="closeMatchModal()"></button>
            </div>
            
            <form id="matchForm" class="form-wide">
                <div>
                    <label for="matchWinner">Winner:</label>
                    <select id="matchWinner" name="winner" required>
                        <option value="">Select Winner</option>
                    </select>
                </div>

                <div id="scoreInputs" style="margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; text-align: center; color: var(--color-text-muted);">Scores (Optional)</h4>
                    <div style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label for="playerOneScore" id="playerOneScoreLabel">Player One Score:</label>
                            <input type="number" id="playerOneScore" name="player_one_score" min="0" step="1" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label for="playerTwoScore" id="playerTwoScoreLabel">Player Two Score:</label>
                            <input type="number" id="playerTwoScore" name="player_two_score" min="0" step="1" style="width: 100%;">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                    <button type="submit" class="button button-primary">Submit</button>
                    <button type="button" class="button" onclick="closeMatchModal()">Cancel</button>
                </div>

                {% if is_admin %}
                <div style="margin-top: 2rem">
                    <h4>Danger Zone</h4>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button type="button" id="deleteMatchBtn" class="button button-danger text-danger" onclick="deleteMatch()" style="display: none;">Delete Match</button>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Add Match Modal -->
    <div id="addMatchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addMatchModalTitle">Add Match</h3>
                <button class="modal-close" onclick="closeAddMatchModal()"></button>
            </div>

            <form id="addMatchForm" class="form-wide">
                {% csrf_token %}
                <div>
                    <label for="addMatchPlayerOne">Player One:</label>
                    <select id="addMatchPlayerOne" name="player_one" required>
                        <option value="">Select Player One</option>
                    </select>
                </div>

                <div>
                    <label for="addMatchPlayerTwo">Player Two:</label>
                    <select id="addMatchPlayerTwo" name="player_two" required>
                        <option value="">Select Player Two</option>
                    </select>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                    <button type="submit" class="button button-primary">Create Match</button>
                    <button type="button" class="button" onclick="closeAddMatchModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Player Match Report Modal -->
    <div id="playerMatchReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="playerMatchReportModalTitle">Report Match Result</h3>
                <button class="modal-close" onclick="closePlayerMatchReportModal()"></button>
            </div>

            <form id="playerMatchReportForm" class="form-wide">
                {% csrf_token %}
                <div>
                    <label for="playerMatchOpponent">Opponent:</label>
                    <select id="playerMatchOpponent" name="opponent" required>
                        <option value="">Select your opponent</option>
                    </select>
                </div>

                <div>
                    <label for="playerMatchWinner">Winner:</label>
                    <select id="playerMatchWinner" name="winner" required>
                        <option value="">Select winner</option>
                        <option value="me">I won</option>
                        <option value="them">They won</option>
                    </select>
                </div>

                <div id="playerScoreInputs" style="margin-top: 1rem; display: none;">
                    <h4 style="margin-bottom: 1rem; text-align: center; color: var(--color-text-muted);">Match Scores</h4>
                    <div style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label for="playerMyScore">My Score:</label>
                            <input type="number" id="playerMyScore" name="my_score" min="0" step="1" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label for="playerTheirScore">Their Score:</label>
                            <input type="number" id="playerTheirScore" name="their_score" min="0" step="1" style="width: 100%;">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                    <button type="submit" class="button button-primary">Submit Result</button>
                    <button type="button" class="button" onclick="closePlayerMatchReportModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function openMatchModal(button) {
        const modal = document.getElementById('matchModal');
        const form = document.getElementById('matchForm');
        const title = document.getElementById('modalTitle');
        const winnerSelect = document.getElementById('matchWinner');
        const deleteBtn = document.getElementById('deleteMatchBtn');

        const matchId = button.dataset.matchId;
        const updateAction = button.dataset.updateAction;
        const deleteAction = button.dataset.deleteAction;
        const playerOne = button.dataset.matchPlayerOne;
        const playerOneId = button.dataset.matchPlayerOneId;
        const playerTwo = button.dataset.matchPlayerTwo;
        const playerTwoId = button.dataset.matchPlayerTwoId;
        const hasResult = button.dataset.matchHasResult === 'true';
        const currentWinnerId = button.dataset.matchWinnerId;

        // Store match info for delete function
        window.currentDeleteAction = deleteAction;
        window.currentMatchPlayerOne = playerOne;
        window.currentMatchPlayerTwo = playerTwo;

        form.setAttribute('hx-post', updateAction);
        form.setAttribute('hx-target', `#match-${matchId}`);
        form.setAttribute('hx-swap', 'outerHTML');
        htmx.process(form);

        // Set modal title
        title.textContent = hasResult ? 'Update Match Result' : 'Report Match Result';

        // Show/hide delete button for admins only
        {% if is_admin %}
        if (deleteBtn) {
            deleteBtn.style.display = 'inline-block';
        }
        {% endif %}

        // Clear and populate winner select
        winnerSelect.innerHTML = '<option value="">Select Winner</option>';


        if (playerOne) {
            const option1 = new Option(playerOne, playerOneId);
            if (currentWinnerId === playerOneId) option1.selected = true;
            winnerSelect.appendChild(option1);
        }

        if (playerTwo) {
            const option2 = new Option(playerTwo, playerTwoId);
            if (currentWinnerId === playerTwoId) option2.selected = true;
            winnerSelect.appendChild(option2);
        }

        // Add tie option only if stage allows ties
        const stageAllowTies = button.dataset.stageAllowTies === 'true';
        if (stageAllowTies) {
            const tieOption = new Option('Tie', '');
            if (!currentWinnerId && hasResult) tieOption.selected = true;
            winnerSelect.appendChild(tieOption);
        }

        // Handle score inputs based on stage settings
        const stageScoreReporting = parseInt(button.dataset.stageScoreReporting);
        const scoreInputsSection = document.getElementById('scoreInputs');

        if (stageScoreReporting === 0) {
            // Score reporting disabled - hide score section
            if (scoreInputsSection) scoreInputsSection.style.display = 'none';
        } else {
            // Score reporting enabled (optional or required) - show score section
            if (scoreInputsSection) scoreInputsSection.style.display = 'block';

            const playerOneScoreLabel = document.getElementById('playerOneScoreLabel');
            const playerTwoScoreLabel = document.getElementById('playerTwoScoreLabel');
            const playerOneScoreInput = document.getElementById('playerOneScore');
            const playerTwoScoreInput = document.getElementById('playerTwoScore');

            // Update labels with player names
            if (playerOneScoreLabel && playerOne) {
                playerOneScoreLabel.textContent = `${playerOne}`;
            }
            if (playerTwoScoreLabel && playerTwo) {
                playerTwoScoreLabel.textContent = `${playerTwo}`;
            } else if (playerTwoScoreLabel) {
                playerTwoScoreLabel.textContent = 'Player Two';
            }

            // Set required attribute based on stage settings
            if (stageScoreReporting === 2) {
                // Required
                if (playerOneScoreInput) playerOneScoreInput.required = true;
                if (playerTwoScoreInput) playerTwoScoreInput.required = true;
            } else {
                // Optional
                if (playerOneScoreInput) playerOneScoreInput.required = false;
                if (playerTwoScoreInput) playerTwoScoreInput.required = false;
            }

            // Populate existing scores if available
            const playerOneScore = button.dataset.matchPlayerOneScore || '';
            const playerTwoScore = button.dataset.matchPlayerTwoScore || '';

            if (playerOneScoreInput) playerOneScoreInput.value = playerOneScore;
            if (playerTwoScoreInput) playerTwoScoreInput.value = playerTwoScore;
        }

        // Show modal
        modal.classList.add('modal--active');
    }


    function closeMatchModal() {
        const modal = document.getElementById('matchModal');
        modal.classList.remove('modal--active');
    }

    {% if is_admin %}
    function deleteMatch() {
        if (!window.currentDeleteAction) return;

        const deleteBtn = document.getElementById('deleteMatchBtn');
        const playerNames = window.currentMatchPlayerTwo
            ? `${window.currentMatchPlayerOne} and ${window.currentMatchPlayerTwo}`
            : window.currentMatchPlayerOne;

        // Set up HTMX attributes on the delete button
        deleteBtn.setAttribute('hx-post', window.currentDeleteAction);
        deleteBtn.setAttribute('hx-confirm', `Are you sure you want to delete this match between ${playerNames}? Our lawyers insist that we ask.`);

        // Process the button with HTMX and trigger the click
        htmx.process(deleteBtn);
        deleteBtn.click();
    }
    {% endif %}

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('matchModal');
        if (e.target === modal) {
            closeMatchModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMatchModal();
        }
    });

    document.addEventListener('htmx:afterRequest', function(e) {
        // Close modal on successful htmx request
        if (e.detail.elt && e.detail.elt.id === 'matchForm' && e.detail.successful) {
            closeMatchModal();
        }
        if (e.detail.elt && e.detail.elt.id === 'addMatchForm' && e.detail.successful) {
            closeAddMatchModal();
        }
    });

    // Add Match Modal Functions
    function openAddMatchModal() {
        const modal = document.getElementById('addMatchModal');
        const form = document.getElementById('addMatchForm');
        const playerOneSelect = document.getElementById('addMatchPlayerOne');
        const playerTwoSelect = document.getElementById('addMatchPlayerTwo');

        // Set up form action
        form.setAttribute('hx-post', '{% url "tourney-add-match" tournament.id %}');
        htmx.process(form);

        // Clear and populate player selects with unmatched players
        playerOneSelect.innerHTML = '<option value="">Select Player One</option>';
        playerTwoSelect.innerHTML = '<option value="">Select Player Two</option>';

        {% if unmatched_players %}
        const isAdmin = {{ is_admin|yesno:"true,false" }};
        const currentUserId = {{ user.id|default:"null" }};
        let currentUserStagePlayerId = null;

        {% for stage_player in unmatched_players %}
        const option1_{{ stage_player.id }} = new Option('{{ stage_player.player.get_display_name|escapejs }}', '{{ stage_player.id }}');
        const option2_{{ stage_player.id }} = new Option('{{ stage_player.player.get_display_name|escapejs }}', '{{ stage_player.id }}');

        {% if stage_player.player.user %}
        if ({{ stage_player.player.user.id }} === currentUserId) {
            currentUserStagePlayerId = '{{ stage_player.id }}';
        }
        {% endif %}

        playerOneSelect.appendChild(option1_{{ stage_player.id }});
        playerTwoSelect.appendChild(option2_{{ stage_player.id }});
        {% endfor %}

        // For non-admin players, pre-select themselves as player one
        if (!isAdmin && currentUserStagePlayerId) {
            playerOneSelect.value = currentUserStagePlayerId;
            playerOneSelect.disabled = true;
        }
        {% endif %}

        // Show modal
        modal.classList.add('modal--active');
    }

    function closeAddMatchModal() {
        const modal = document.getElementById('addMatchModal');
        const playerOneSelect = document.getElementById('addMatchPlayerOne');

        // Re-enable player one select in case it was disabled
        if (playerOneSelect) {
            playerOneSelect.disabled = false;
        }

        modal.classList.remove('modal--active');
    }

    // Close add match modal when clicking outside or pressing Escape
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('addMatchModal');
        if (e.target === modal) {
            closeAddMatchModal();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAddMatchModal();
            closePlayerMatchReportModal();
        }
    });

    // Player Match Report Modal Functions
    function openPlayerMatchReportModal() {
        const modal = document.getElementById('playerMatchReportModal');
        const form = document.getElementById('playerMatchReportForm');
        const opponentSelect = document.getElementById('playerMatchOpponent');
        const winnerSelect = document.getElementById('playerMatchWinner');
        const scoreInputsSection = document.getElementById('playerScoreInputs');

        // Set up form action
        form.setAttribute('hx-post', '{% url "tourney-player-add-match-result" tournament.id %}');
        htmx.process(form);

        // Clear opponent select
        opponentSelect.innerHTML = '<option value="">Select your opponent</option>';

        // Populate opponent options with unmatched players (excluding current user)
        {% if unmatched_players %}
        const currentUserId = {{ user.id|default:"null" }};

        {% for stage_player in unmatched_players %}
        {% if stage_player.player.user %}
        if ({{ stage_player.player.user.id }} !== currentUserId) {
            const option = new Option('{{ stage_player.player.get_display_name|escapejs }}', '{{ stage_player.id }}');
            opponentSelect.appendChild(option);
        }
        {% else %}
        // Guest player - always include
        const option = new Option('{{ stage_player.player.get_display_name|escapejs }}', '{{ stage_player.id }}');
        opponentSelect.appendChild(option);
        {% endif %}
        {% endfor %}
        {% endif %}

        // Handle score inputs and tie option based on stage settings
        const stageAllowTies = {{ selected_stage.are_ties_allowed|yesno:"true,false"|default:"false" }};
        const stageScoreReporting = {{ selected_stage.report_full_scores|default:"0" }};

        // Clear and setup winner select
        winnerSelect.innerHTML = '<option value="">Select winner</option>';
        winnerSelect.innerHTML += '<option value="me">I won</option>';
        winnerSelect.innerHTML += '<option value="them">They won</option>';

        if (stageAllowTies) {
            winnerSelect.innerHTML += '<option value="tie">Tie</option>';
        }

        // Handle score inputs
        if (stageScoreReporting > 0) {
            scoreInputsSection.style.display = 'block';
            const myScoreInput = document.getElementById('playerMyScore');
            const theirScoreInput = document.getElementById('playerTheirScore');

            if (stageScoreReporting === 2) {
                // Required
                myScoreInput.required = true;
                theirScoreInput.required = true;
            } else {
                // Optional
                myScoreInput.required = false;
                theirScoreInput.required = false;
            }
        } else {
            scoreInputsSection.style.display = 'none';
        }

        // Show modal
        modal.classList.add('modal--active');
    }

    function closePlayerMatchReportModal() {
        const modal = document.getElementById('playerMatchReportModal');
        modal.classList.remove('modal--active');
    }

    // Close player match report modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('playerMatchReportModal');
        if (e.target === modal) {
            closePlayerMatchReportModal();
        }
    });

    // Handle form submission success
    document.addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.elt && e.detail.elt.id === 'playerMatchReportForm' && e.detail.successful) {
            closePlayerMatchReportModal();
        }
    });
    </script>
{% endblock %}