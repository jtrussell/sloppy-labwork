{% extends "tourney/_base.html" %}
{% load partials %}
{% load posts_extras %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'tourney/round-countdown.css' %}">
    {% if active_timer %}
    <link rel="stylesheet" href="{% static 'timekeeper/timer.css' %}">
    {% endif %}
    <h1>{{ tournament.name }}</h1>

    {% if tournament.description %}
        <section>{{ tournament.description | markdown | safe }}</section>
    {% endif %}

    {% include "tourney/partials/tournament-detail-registration-status.html" %}

    {% if active_timer %}
    <div class="tournament-timer-display">
        {% if is_admin %}
            {% include "timekeeper/timer-with-controls.html" with code=timer_context.code name=timer_context.name state=timer_context.state end_time_ms=timer_context.end_time_ms pause_time_remaining_seconds=timer_context.pause_time_remaining_seconds %}
        {% else %}
            {% include "timekeeper/timer.html" with code=timer_context.code name=timer_context.name state=timer_context.state end_time_ms=timer_context.end_time_ms pause_time_remaining_seconds=timer_context.pause_time_remaining_seconds %}
        {% endif %}
    </div>
    {% elif current_round.get_end_timestamp %}
    <div class="round-countdown-container">
        <div class="round-countdown-label">Round Time Remaining:</div>
        <div class="round-countdown" data-end-timestamp="{{ current_round.get_end_timestamp }}">
            <span class="countdown-display">--:--</span>
        </div>
    </div>
    {% endif %}

    <!-- Pending Matches for Current User -->
    {% include "tourney/partials/my-pending-matches.html" %}

    <!-- Tab Navigation -->
     <section>
        <ul class="nav short">
            <li class="nav__item">
                <a href="{% url 'tourney-detail-matches' tournament.code %}"
                class="nav__link {% if current_tab == 'matches' %}nav__link--active{% endif %}">
                    Matches
                </a>
            </li>
            <li class="nav__item">
                <a href="{% url 'tourney-detail-standings' tournament.code %}"
                class="nav__link {% if current_tab == 'standings' %}nav__link--active{% endif %}">
                    Standings
                </a>
            </li>
            {% if is_admin %}
            <li class="nav__item">
                <a href="{% url 'tourney-tournament-detail-admin' tournament.code %}"
                class="nav__link {% if current_tab == 'admin' %}nav__link--active{% endif %}">
                    Admin
                </a>
            </li>
            {% endif %}
        </ul>
     </section>

     <section>
        {% block tab_content %}
        {% endblock %}
     </section>

    <!-- Match Result Modal -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Report Match Result</h3>
                <button class="modal-close" onclick="closeMatchModal()"></button>
            </div>
            
            <form id="matchForm" class="form-wide">
                <div>
                    <label for="matchWinner">Winner:</label>
                    <select id="matchWinner" name="winner" required>
                        <option value="">Select Winner</option>
                    </select>
                </div>

                <div id="scoreInputs">
                    <h4>Scores (Optional)</h4>
                    <div>
                        <div>
                            <label for="playerOneScore" id="playerOneScoreLabel">Player One Score:</label>
                            <input type="number" id="playerOneScore" name="player_one_score" min="0" step="1">
                        </div>
                        <div>
                            <label for="playerTwoScore" id="playerTwoScoreLabel">Player Two Score:</label>
                            <input type="number" id="playerTwoScore" name="player_two_score" min="0" step="1">
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Submit</button>
                    <button type="button" class="button" onclick="closeMatchModal()">Cancel</button>
                </div>

                {% if is_admin %}
                <div class="modal-danger-zone">
                    <h4>Danger Zone</h4>
                    <div class="modal-danger-actions">
                        <button type="button" id="resetMatchBtn" class="button button-secondary" onclick="resetMatch()" style="display: none;">Reset Match</button>
                        <button type="button" id="deleteMatchBtn" class="button button-danger" onclick="deleteMatch()" style="display: none;">Delete Match</button>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Add Match Modal -->
    <div id="addMatchModal" class="modal"
         data-add-match-url="{% url 'tourney-add-match' tournament.code %}"
         data-unmatched-players='{{ unmatched_players_json|default:"[]"|safe }}'
         data-is-admin="{{ is_admin|yesno:"true,false" }}"
         data-current-user-id="{{ user.id|default:"null" }}">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addMatchModalTitle" class="modal-title">Add Match</h3>
                <button class="modal-close" onclick="closeAddMatchModal()"></button>
            </div>

            <p class="text-muted">You may only create matches for players not currently matched in the current round.</p>

            <form id="addMatchForm" class="form-wide">
                {% csrf_token %}
                <div>
                    <label for="addMatchPlayerOne">Player One:</label>
                    <select id="addMatchPlayerOne" name="player_one" required>
                        <option value="">Select Player One</option>
                    </select>
                </div>

                <div>
                    <label for="addMatchPlayerTwo">Player Two:</label>
                    <select id="addMatchPlayerTwo" name="player_two">
                        <option value="">Select Player Two (Bye)</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Create Match</button>
                    <button type="button" class="button" onclick="closeAddMatchModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Player Match Report Modal -->
    <div id="playerMatchReportModal" class="modal"
         data-report-url="{% url 'tourney-player-add-match-result' tournament.code %}"
         data-unmatched-players='{{ unmatched_players_json|default:"[]"|safe }}'
         data-current-user-id="{{ user.id|default:"null" }}"
         data-stage-allow-ties="{{ selected_stage.are_ties_allowed|yesno:"true,false"|default:"false" }}"
         data-stage-score-reporting="{{ selected_stage.report_full_scores|default:"0" }}">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="playerMatchReportModalTitle">Report Match Result</h3>
                <button class="modal-close" onclick="closePlayerMatchReportModal()"></button>
            </div>

            <form id="playerMatchReportForm" class="form-wide">
                {% csrf_token %}
                <div>
                    <label for="playerMatchOpponent">Opponent:</label>
                    <select id="playerMatchOpponent" name="opponent" required>
                        <option value="">Select your opponent</option>
                    </select>
                </div>

                <div>
                    <label for="playerMatchWinner">Winner:</label>
                    <select id="playerMatchWinner" name="winner" required>
                        <option value="">Select winner</option>
                        <option value="me">I won</option>
                        <option value="them">They won</option>
                    </select>
                </div>

                <div id="playerScoreInputs">
                    <h4>Match Scores</h4>
                    <div>
                        <div>
                            <label for="playerMyScore">My Score:</label>
                            <input type="number" id="playerMyScore" name="my_score" min="0" step="1">
                        </div>
                        <div>
                            <label for="playerTheirScore">Their Score:</label>
                            <input type="number" id="playerTheirScore" name="their_score" min="0" step="1">
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Submit Result</button>
                    <button type="button" class="button" onclick="closePlayerMatchReportModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    {% if is_admin %}
    <!-- Start Timer Modal -->
    <div id="startTimerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Start Timer</h3>
                <button class="modal-close" onclick="closeStartTimerModal()"></button>
            </div>

            <form method="post" action="{% url 'tourney-create-timer' tournament.code %}" class="form-wide">
                {% csrf_token %}
                <div>
                    <label for="timerMinutes">Timer Length (minutes):</label>
                    <input type="number" id="timerMinutes" name="minutes" min="1" required value="50">
                </div>

                <div>
                    <label for="timerName">Timer Name (optional):</label>
                    <input type="text" id="timerName" name="name" placeholder="{{ default_timer_name }}" value="">
                </div>

                <div class="modal-actions">
                    <button type="submit" class="button button-primary">Start Timer</button>
                    <button type="button" class="button" onclick="closeStartTimerModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openStartTimerModal() {
            document.getElementById('startTimerModal').classList.add('modal--active');
        }
        function closeStartTimerModal() {
            document.getElementById('startTimerModal').classList.remove('modal--active');
        }
        document.getElementById('startTimerModal').addEventListener('click', function(e) {
            if (e.target === this) closeStartTimerModal();
        });
    </script>
    {% endif %}

    <script src="{% static 'tourney/tournament-modals.js' %}"></script>
    <script src="{% static 'tourney/round-countdown.js' %}"></script>
    {% if active_timer %}
    <script src="{% static 'timekeeper/timer.js' %}"></script>
    {% endif %}
{% endblock %}